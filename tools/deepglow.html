<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leo's Dev Tools - PhotoGlow Ultimate</title>
    
<script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: { 850: '#1f2937', 900: '#111827', 950: '#030712' },
                        accent: { 500: '#8b5cf6', 600: '#7c3aed', glow: 'rgba(139, 92, 246, 0.5)' }
                    },
                    fontFamily: { mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace'] }
                }
            }
        }
    </script>
    <style>
        /* ä»æ‚¨çš„ Deepglow æ–‡ä»¶ç»§æ‰¿çš„è‡ªå®šä¹‰æ ·å¼ */
        input[type=range] { 
            -webkit-appearance: none; 
            width: 100%; 
            background: transparent; 
            margin: 6px 0; 
            cursor: pointer; 
            touch-action: none; 
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #374151; border-radius: 2px; }
        input[type=range]:hover::-webkit-slider-runnable-track { background: #4b5563; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #e5e7eb; margin-top: -5px; border: 2px solid #1f2937; transition: all 0.2s ease; }
        input[type=range]:focus::-webkit-slider-thumb, input[type=range]:active::-webkit-slider-thumb { background: #8b5cf6; border-color: #fff; transform: scale(1.2); box-shadow: 0 0 15px rgba(139, 92, 246, 0.8); }
        .canvas-bg { background-color: #030712; background-image: linear-gradient(45deg, #0f172a 25%, transparent 25%), linear-gradient(-45deg, #0f172a 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #0f172a 75%), linear-gradient(-45deg, transparent 75%, #0f172a 75%); background-size: 24px 24px; }
        .glass-panel { background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-left: 1px solid rgba(255,255,255,0.05); }
        .value-badge { font-family: 'ui-monospace', monospace; font-size: 11px; color: #9ca3af; background: rgba(0,0,0,0.3); padding: 1px 6px; border-radius: 4px; min-width: 36px; text-align: right; border: 1px solid rgba(255,255,255,0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        /* æ–°å¢ï¼šä¾§è¾¹æ å’Œå†…å®¹åŒºçš„è¿‡æ¸¡å’Œå¸ƒå±€æ§åˆ¶ */
        .sidebar {
            transition: transform 0.3s ease-out;
        }
        .content-wrap {
            transition: margin-left 0.3s ease-out;
        }
        .overlay {
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 40; 
        }

        /* æ‚¨çš„ Deepglow ç§»åŠ¨ç«¯å¸ƒå±€ */
        @media (max-width: 768px) {
            .mobile-layout { flex-direction: column; }
            .canvas-container-mobile { flex: 1; width: 100%; min-height: 0; }
            .mobile-panel { width: 100%; height: 50vh; border-left: none; border-top: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; }
            input[type=range]::-webkit-slider-thumb { height: 20px; width: 20px; margin-top: -8px; }
            /* è°ƒæ•´ä¸»å†…å®¹åŒºåœ¨ç§»åŠ¨ç«¯é€‚åº”ä¾§è¾¹æ  */
            .deepglow-container { flex: 1; width: 100%; }
        }
        @media (min-width: 769px) { 
            .mobile-panel { width: 340px; height: 100%; display: flex; flex-direction: column; } 
            .canvas-container-mobile { flex: 1; height: 100%; } 
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans min-h-screen flex flex-col">
    
    <header class="h-16 bg-gray-950/80 backdrop-blur-md border-b border-gray-800 flex items-center px-4 md:px-6 z-20 shrink-0 relative">
        <div class="flex items-center">
            <button id="sidebar-toggle" class="lg:hidden text-white focus:outline-none mr-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <a href="../index.html" class="text-2xl font-extrabold tracking-tight text-white hover:text-accent-500 transition-colors">
                <span class="inline-block transform hover:scale-105 transition-transform">âœ¨ Leo's Dev Tools</span>
            </a>
        </div>
        
</header>

    
    <div class="flex flex-1 relative overflow-hidden">
        
        <aside id="sidebar" class="sidebar bg-gray-950 text-gray-200 w-64 p-6 space-y-6 flex flex-col flex-shrink-0
                                   fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0
                                   lg:relative lg:shadow-xl lg:z-auto z-50 transition-transform duration-300 ease-in-out border-r border-gray-800">
            <h2 class="text-xl font-bold text-white mb-4">æˆ‘çš„å·¥å…·ç®±</h2>
            <nav class="flex-grow">
                <ul class="space-y-2">
                    <li><a href="../index.html" class="block py-2 px-3 rounded-lg hover:bg-gray-800 transition-colors flex items-center"><span class="mr-2">ğŸ </span> é¦–é¡µ</a></li>
                    <li><a href="deepglow.html" class="block py-2 px-3 rounded-lg bg-accent-600/80 text-white hover:bg-accent-500 transition-colors flex items-center"><span class="mr-2">âš¡</span> PhotoGlow Ultimate</a></li>
                    <li><a href="#" class="block py-2 px-3 rounded-lg hover:bg-gray-800 transition-colors flex items-center opacity-50 cursor-not-allowed"><span class="mr-2">ğŸ”§</span> Tool B (å¾…å®š)</a></li>
                    <li><a href="#" class="block py-2 px-3 rounded-lg hover:bg-gray-800 transition-colors flex items-center opacity-50 cursor-not-allowed"><span class="mr-2">ğŸ“</span> Tool C (å¾…å®š)</a></li>
                    
</ul>
            </nav>
        </aside>

        
<div id="sidebar-overlay" class="overlay hidden fixed inset-0 z-40 lg:hidden"></div>

        
        <main id="content-area" class="content-wrap flex-grow relative overflow-hidden flex flex-col h-full lg:ml-0">
            <header class="h-14 bg-gray-900/80 backdrop-blur-md border-b border-gray-800 flex items-center justify-between px-4 md:px-6 z-20 shrink-0">
                <div class="flex items-center gap-2 md:gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-accent-600 to-blue-600 flex items-center justify-center shadow-lg shadow-accent-500/20">
                        <i class="fas fa-bolt text-white text-sm"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-sm md:text-base tracking-wider text-white leading-tight">PhotoGlow <span class="text-accent-500">Ultimate</span></h1>
                    </div>
                </div>
                <div class="flex gap-2 md:gap-3">
                    <label for="uploadInput" class="cursor-pointer bg-gray-800 hover:bg-gray-700 hover:text-white border border-gray-700 text-gray-300 transition-all duration-200 px-3 md:px-4 py-1.5 rounded-full text-xs font-medium flex items-center gap-2">
                        <i class="fas fa-folder-open text-xs"></i>
                        <span class="hidden md:inline">æ‰“å¼€å›¾ç‰‡</span>
                        <span class="md:hidden">æ‰“å¼€</span>
                    </label>
                    <input type="file" id="uploadInput" accept="image/*" class="hidden">
                    
                    <button id="compareBtn" class="bg-gray-700 hover:bg-gray-600 text-white border border-gray-600 transition-all duration-200 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 disabled:opacity-50" disabled title="æŒ‰ä½å¯¹æ¯”åŸå›¾">
                        <i class="fas fa-eye text-xs"></i>
                        <span class="hidden md:inline">æŒ‰ä½å¯¹æ¯”</span>
                    </button>

                    <button id="downloadBtn" class="bg-accent-600 hover:bg-accent-500 text-white shadow-lg shadow-accent-600/30 transition-all duration-200 px-3 md:px-5 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-file-export text-xs"></i>
                        <span>å¯¼å‡º</span>
                    </button>
                </div>
            </header>
            
            <main class="flex-1 flex mobile-layout overflow-hidden relative w-full h-full">
                <div class="relative flex items-center justify-center p-4 canvas-bg overflow-hidden group canvas-container-mobile" id="dropZone">
                    <div id="emptyState" class="text-center pointer-events-none flex flex-col items-center transition-opacity duration-500">
                        <div class="w-20 h-20 rounded-full bg-gray-900 border border-gray-800 flex items-center justify-center mb-4 shadow-2xl">
                            <i class="fas fa-plus text-gray-700 text-3xl"></i>
                        </div>
                        <p class="text-lg font-light text-gray-400 tracking-wide">æ‹–å…¥å›¾ç‰‡ æˆ– ç‚¹å‡»æ‰“å¼€</p>
                        <p class="text-xs mt-2 text-gray-600 font-mono border border-gray-800 px-3 py-1 rounded-full">GPU Accelerated</p>
                    </div>
                    
                    <canvas id="glCanvas" class="shadow-2xl shadow-black/50 object-contain hidden" style="max-width: 100%; max-height: 100%;"></canvas>
                    
                    <div id="compareLabel" class="absolute top-4 left-4 bg-red-500/80 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur hidden pointer-events-none z-20">
                        ORIGINAL
                    </div>

                    <div id="loadingIndicator" class="absolute inset-0 bg-gray-950/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center hidden">
                        <div class="w-10 h-10 border-4 border-gray-800 border-t-accent-500 rounded-full animate-spin"></div>
                        <p class="text-xs text-accent-500 mt-3 font-mono">PROCESSING...</p>
                    </div>
                </div>

                <aside class="glass-panel shrink-0 z-10 shadow-2xl relative mobile-panel">
                    <div class="px-4 py-3 border-b border-gray-800 flex justify-between items-center bg-gray-900/40 shrink-0">
                        <div class="flex items-center gap-2 text-gray-400">
                            <i class="fas fa-sliders-h text-xs"></i>
                            <h2 class="font-bold text-xs uppercase tracking-widest">Parameters</h2>
                        </div>
                        <button id="resetBtn" class="text-[10px] text-gray-500 hover:text-white transition-colors bg-gray-800 hover:bg-gray-700 px-2 py-1 rounded border border-gray-700">RESET</button>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-5 pb-10">
                        
                        <section>
                            <div class="flex items-center gap-2 text-accent-400 mb-3">
                                <i class="fas fa-sun text-sm"></i>
                                <span class="font-bold text-sm tracking-wide">Deep Glow (è¾‰å…‰)</span>
                            </div>
                            <div class="bg-gray-900/50 rounded-xl p-3 border border-gray-800 space-y-3">
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-gray-400"><span>å¼ºåº¦ (Intensity)</span><span id="bloomStrengthVal" class="value-badge">0.0</span></div>
                                    <input type="range" id="bloomStrength" min="0" max="300" value="0" step="1">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-gray-400"><span>é˜ˆå€¼ (Threshold)</span><span id="bloomThresholdVal" class="value-badge">0.70</span></div>
                                    <input type="range" id="bloomThreshold" min="0" max="100" value="70" step="1">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-gray-400"><span>æ‰©æ•£åŠå¾„ (Radius)</span><span id="bloomRadiusVal" class="value-badge">1.0</span></div>
                                    <input type="range" id="bloomRadius" min="0" max="500" value="100" step="1">
                                </div>
                            </div>
                        </section>

                        <section>
                            <div class="flex items-center gap-2 text-yellow-200/80 mb-3">
                                <i class="fas fa-film text-sm"></i>
                                <span class="font-bold text-sm tracking-wide">Film Look (èƒ¶ç‰‡)</span>
                            </div>
                            <div class="bg-gray-900/50 rounded-xl p-3 border border-gray-800 space-y-3">
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-gray-400"><span>é¢—ç²’ (Grain)</span><span id="grainVal" class="value-badge">0.0</span></div>
                                    <input type="range" id="grain" min="0" max="100" value="0" step="1">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-gray-400"><span>æš—è§’ (Vignette)</span><span id="vignetteVal" class="value-badge">0.0</span></div>
                                    <input type="range" id="vignette" min="0" max="100" value="0" step="1">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-gray-400"><span>è‰²å·® (Aberration)</span><span id="aberrationVal" class="value-badge">0.0</span></div>
                                    <input type="range" id="aberration" min="0" max="100" value="0" step="1">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-gray-400"><span>è‰²æ¸© (Temp)</span><span id="temperatureVal" class="value-badge">0.0</span></div>
                                    <input type="range" id="temperature" min="-50" max="50" value="0" step="1" style="background: linear-gradient(90deg, #93c5fd 0%, #374151 50%, #fcd34d 100%);">
                                </div>
                            </div>
                        </section>

                        <section>
                            <div class="flex items-center gap-2 text-blue-300/80 mb-3">
                                <i class="fas fa-adjust text-sm"></i>
                                <span class="font-bold text-sm tracking-wide">Tone (å½±è°ƒ)</span>
                            </div>
                            <div class="bg-gray-900/50 rounded-xl p-3 border border-gray-800 grid grid-cols-2 gap-3">
                                <div class="col-span-2">
                                    <div class="flex justify-between text-xs mb-1 text-gray-400"><span>æ›å…‰ (Exposure)</span><span id="exposureVal" class="value-badge">0.0</span></div>
                                    <input type="range" id="exposure" min="-100" max="100" value="0" step="1">
                                </div>
                                <div class="col-span-2">
                                    <div class="flex justify-between text-xs mb-1 text-gray-400"><span>å¯¹æ¯”åº¦ (Contrast)</span><span id="contrastVal" class="value-badge">0.0</span></div>
                                    <input type="range" id="contrast" min="-100" max="100" value="0" step="1">
                                </div>
                                <div class="col-span-2">
                                    <div class="flex justify-between text-xs mb-1 text-gray-400"><span>é¥±å’Œåº¦ (Sat)</span><span id="saturationVal" class="value-badge">0.0</span></div>
                                    <input type="range" id="saturation" min="-100" max="100" value="0" step="1">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-gray-500">Highs</div>
                                    <input type="range" id="highlights" min="-100" max="100" value="0" step="1">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs mb-1 text-gray-500">Shadows</div>
                                    <input type="range" id="shadows" min="-100" max="100" value="0" step="1">
                                </div>
                            </div>
                        </section>
                        
                        <div class="h-8 md:hidden"></div>
                    </div>
                </aside>
            </main>
        </main>
    </div>
    
    <div id="saveModal" class="modal-overlay">
        <div class="bg-gray-900 rounded-xl p-4 max-w-sm w-full mx-4 border border-gray-700 shadow-2xl flex flex-col items-center">
            <h3 class="text-white font-bold mb-2">å›¾ç‰‡å·²ç”Ÿæˆ</h3>
            <p class="text-xs text-gray-400 mb-4 text-center">é•¿æŒ‰ä¸‹æ–¹å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ</p>
            <div class="w-full h-64 bg-black rounded-lg border border-gray-800 mb-4 flex items-center justify-center overflow-hidden">
                <img id="saveImg" src="" alt="Result" class="max-w-full max-h-full object-contain">
            </div>
            <button id="closeModalBtn" class="w-full bg-gray-800 hover:bg-gray-700 text-white py-2 rounded-lg text-sm font-medium transition-colors">
                å…³é—­
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const contentArea = document.getElementById('content-area'); // ä¸»å†…å®¹åŒº

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            }

            sidebarToggle.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar); // ç‚¹å‡»é®ç½©ä¹Ÿå…³é—­ä¾§è¾¹æ 

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œç¡®ä¿æ¡Œé¢ç«¯ä¾§è¾¹æ é»˜è®¤æ˜¾ç¤º
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) { // lg breakpoint
                    sidebar.classList.remove('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                }
            });
        });
    </script>
    
    <script>
        // --- WebGL Shader Source Code ---
        
        const VS_SOURCE = `
            attribute vec2 a_position;
            attribute vec2 a_texCoord;
            varying vec2 v_texCoord;
            void main() {
                gl_Position = vec4(a_position, 0, 1);
                v_texCoord = a_texCoord;
            }
        `;

        const FS_COPY = `
            precision mediump float;
            varying vec2 v_texCoord;
            uniform sampler2D u_image;
            void main() {
                gl_FragColor = texture2D(u_image, v_texCoord);
            }
        `;

        const FS_PREPROCESS = `
            precision mediump float;
            varying vec2 v_texCoord;
            uniform sampler2D u_image;
            
            uniform float u_exposure;
            uniform float u_contrast;
            uniform float u_saturation;
            uniform float u_temp;
            uniform float u_highs;
            uniform float u_shadows;
            
            uniform float u_bloomThresh;

            vec3 adjustColor(vec3 color) {
                color = color * pow(2.0, u_exposure);
                color = (color - 0.5) * (u_contrast + 1.0) + 0.5;
                float gray = dot(color, vec3(0.299, 0.587, 0.114));
                color = mix(vec3(gray), color, u_saturation + 1.0);
                color.r += u_temp * 0.1;
                color.b -= u_temp * 0.1;
                float lum = dot(color, vec3(0.2126, 0.7152, 0.0722));
                float shadowFactor = 1.0 - smoothstep(0.0, 0.5, lum);
                float highFactor = smoothstep(0.5, 1.0, lum);
                color += shadowFactor * vec3(u_shadows) * 0.2; 
                color += highFactor * vec3(u_highs) * 0.2;
                return clamp(color, 0.0, 1.0);
            }

            void main() {
                vec4 texColor = texture2D(u_image, v_texCoord);
                vec3 color = adjustColor(texColor.rgb);
                gl_FragColor = vec4(color, 1.0);
            }
        `;

        const FS_BLUR = `
            precision mediump float;
            varying vec2 v_texCoord;
            uniform sampler2D u_image;
            uniform vec2 u_resolution;
            uniform vec2 u_direction; 
            uniform bool u_isFirstPass; 
            uniform float u_bloomThresh;

            void main() {
                vec2 off1 = vec2(1.3846153846) * u_direction;
                vec2 off2 = vec2(3.2307692308) * u_direction;
                vec3 color = vec3(0.0);
                float weight0 = 0.227027;
                float weight1 = 0.316216; 
                float weight2 = 0.070270;
                
                vec4 c = texture2D(u_image, v_texCoord);
                vec3 center = c.rgb;
                if (u_isFirstPass) {
                    float brightness = dot(center, vec3(0.2126, 0.7152, 0.0722));
                    center *= smoothstep(u_bloomThresh, u_bloomThresh + 0.1, brightness);
                }
                color += center * weight0;
                
                vec3 s1 = texture2D(u_image, v_texCoord + (off1 / u_resolution)).rgb;
                vec3 s2 = texture2D(u_image, v_texCoord - (off1 / u_resolution)).rgb;
                if(u_isFirstPass) {
                    float b1 = dot(s1, vec3(0.2126, 0.7152, 0.0722)); s1 *= smoothstep(u_bloomThresh, u_bloomThresh+0.1, b1);
                    float b2 = dot(s2, vec3(0.2126, 0.7152, 0.0722)); s2 *= smoothstep(u_bloomThresh, u_bloomThresh+0.1, b2);
                }
                color += (s1 + s2) * weight1;
                
                vec3 s3 = texture2D(u_image, v_texCoord + (off2 / u_resolution)).rgb;
                vec3 s4 = texture2D(u_image, v_texCoord - (off2 / u_resolution)).rgb;
                if(u_isFirstPass) {
                    float b3 = dot(s3, vec3(0.2126, 0.7152, 0.0722)); s3 *= smoothstep(u_bloomThresh, u_bloomThresh+0.1, b3);
                    float b4 = dot(s4, vec3(0.2126, 0.7152, 0.0722)); s4 *= smoothstep(u_bloomThresh, u_bloomThresh+0.1, b4);
                }
                color += (s3 + s4) * weight2;
                gl_FragColor = vec4(color, 1.0);
            }
        `;

        const FS_COMPOSITE = `
            precision mediump float;
            varying vec2 v_texCoord;
            uniform sampler2D u_base;  
            uniform sampler2D u_bloom; 
            
            uniform float u_bloomStrength;
            uniform float u_grain;
            uniform float u_vignette;
            uniform float u_aberration; 
            uniform float u_time; 

            float rand(vec2 n) { return fract(sin(dot(n, vec2(12.9898, 4.1414))) * 43758.5453); }

            void main() {
                vec3 baseColor;
                if (u_aberration > 0.0) {
                    float dist = distance(v_texCoord, vec2(0.5));
                    vec2 offset = (v_texCoord - 0.5) * u_aberration * dist * 0.05;
                    float r = texture2D(u_base, v_texCoord - offset).r;
                    float g = texture2D(u_base, v_texCoord).g;
                    float b = texture2D(u_base, v_texCoord + offset).b;
                    baseColor = vec3(r, g, b);
                } else {
                    baseColor = texture2D(u_base, v_texCoord).rgb;
                }

                vec3 bloomColor = texture2D(u_bloom, v_texCoord).rgb;
                vec3 result = baseColor + (bloomColor * u_bloomStrength);
                
                vec2 uv = v_texCoord * 2.0 - 1.0; 
                float dist = length(uv);
                float vig = smoothstep(0.5, 1.5, dist * (1.0 + u_vignette));
                result *= (1.0 - vig * 0.6 * u_vignette);

                if (u_grain > 0.0) {
                    float noise = rand(v_texCoord * 10.0 + mod(u_time, 10.0));
                    float lum = dot(result, vec3(0.2126, 0.7152, 0.0722));
                    float mask = 1.0 - pow(abs(lum - 0.5) * 2.0, 2.0); 
                    result = mix(result, result + (noise - 0.5) * 0.2, u_grain * mask);
                }
                gl_FragColor = vec4(result, 1.0);
            }
        `;

        const canvas = document.getElementById('glCanvas');
        const gl = canvas.getContext('webgl', { preserveDrawingBuffer: true, alpha: false }); 
        
        const state = {
            textureOriginal: null,
            fboBase: null, fboPing: null, fboPong: null, 
            width: 0, height: 0, programs: {}, isComparing: false
        };

        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) return null;
            return shader;
        }

        function createProgram(gl, vsSource, fsSource) {
            const vs = createShader(gl, gl.VERTEX_SHADER, vsSource);
            const fs = createShader(gl, gl.FRAGMENT_SHADER, fsSource);
            const prog = gl.createProgram();
            gl.attachShader(prog, vs);
            gl.attachShader(prog, fs);
            gl.linkProgram(prog);
            return prog;
        }

        function createTexture(gl, image) {
            const tex = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, tex);
            gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            if (image) gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
            return tex;
        }

        function createFramebuffer(gl, width, height) {
            const fbo = gl.createFramebuffer();
            gl.bindFramebuffer(gl.FRAMEBUFFER, fbo);
            const tex = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, tex);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, tex, 0);
            return { fbo, tex, width, height };
        }

        function initGL() {
            if (!gl) return;
            state.programs.copy = createProgram(gl, VS_SOURCE, FS_COPY);
            state.programs.preprocess = createProgram(gl, VS_SOURCE, FS_PREPROCESS);
            state.programs.blur = createProgram(gl, VS_SOURCE, FS_BLUR);
            state.programs.composite = createProgram(gl, VS_SOURCE, FS_COMPOSITE);
            const buf = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buf);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1, -1, 0, 0, 1, -1, 1, 0, -1, 1, 0, 1, -1, 1, 0, 1, 1, -1, 1, 0, 1, 1, 1, 1]), gl.STATIC_DRAW);
        }

        function loadImage(src) {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            const img = new Image();
            img.onload = () => {
                state.width = img.width;
                state.height = img.height;
                canvas.width = state.width;
                canvas.height = state.height;
                if (state.textureOriginal) gl.deleteTexture(state.textureOriginal);
                state.textureOriginal = createTexture(gl, img);
                const bloomScale = 0.5;
                state.fboBase = createFramebuffer(gl, state.width, state.height);
                state.fboPing = createFramebuffer(gl, state.width * bloomScale, state.height * bloomScale);
                state.fboPong = createFramebuffer(gl, state.width * bloomScale, state.height * bloomScale);
                document.getElementById('emptyState').classList.add('hidden');
                canvas.classList.remove('hidden');
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('compareBtn').disabled = false;
                document.getElementById('loadingIndicator').classList.add('hidden');
                requestAnimationFrame(render);
            };
            img.src = src;
        }

        function render() {
            if (!state.textureOriginal) return;
            gl.viewport(0, 0, state.width, state.height);
            
            if (state.isComparing) {
                gl.bindFramebuffer(gl.FRAMEBUFFER, null);
                gl.useProgram(state.programs.copy);
                bindQuad(state.programs.copy);
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, state.textureOriginal);
                gl.uniform1i(gl.getUniformLocation(state.programs.copy, "u_image"), 0);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
                return;
            }

            gl.useProgram(state.programs.preprocess);
            gl.bindFramebuffer(gl.FRAMEBUFFER, state.fboBase.fbo);
            bindUniformsPreprocess();
            bindQuad(state.programs.preprocess);
            gl.activeTexture(gl.TEXTURE0);
            gl.bindTexture(gl.TEXTURE_2D, state.textureOriginal);
            gl.uniform1i(gl.getUniformLocation(state.programs.preprocess, "u_image"), 0);
            gl.drawArrays(gl.TRIANGLES, 0, 6);

            const radius = parseInt(document.getElementById('bloomRadius').value) / 20; 
            const iterations = Math.max(2, Math.floor(radius)); 
            
            gl.useProgram(state.programs.blur);
            bindQuad(state.programs.blur);
            
            gl.bindFramebuffer(gl.FRAMEBUFFER, state.fboPing.fbo);
            gl.viewport(0, 0, state.fboPing.width, state.fboPing.height);
            gl.activeTexture(gl.TEXTURE0);
            gl.bindTexture(gl.TEXTURE_2D, state.fboBase.tex);
            gl.uniform1i(gl.getUniformLocation(state.programs.blur, "u_image"), 0);
            
            const uRes = gl.getUniformLocation(state.programs.blur, "u_resolution");
            const uDir = gl.getUniformLocation(state.programs.blur, "u_direction");
            const uFirst = gl.getUniformLocation(state.programs.blur, "u_isFirstPass");
            const uThresh = gl.getUniformLocation(state.programs.blur, "u_bloomThresh");
            
            gl.uniform2f(uRes, state.fboPing.width, state.fboPing.height);
            gl.uniform2f(uDir, 1.0, 0.0);
            gl.uniform1i(uFirst, 1);
            gl.uniform1f(uThresh, parseInt(document.getElementById('bloomThreshold').value) / 100);
            gl.drawArrays(gl.TRIANGLES, 0, 6);

            let currFBO = state.fboPing; 
            let nextFBO = state.fboPong;
            for (let i = 0; i < iterations; i++) {
                gl.bindFramebuffer(gl.FRAMEBUFFER, nextFBO.fbo);
                gl.bindTexture(gl.TEXTURE_2D, currFBO.tex);
                gl.uniform2f(uDir, 0.0, 1.0);
                gl.uniform1i(uFirst, 0); 
                gl.drawArrays(gl.TRIANGLES, 0, 6);
                let temp = currFBO; currFBO = nextFBO; nextFBO = temp;

                gl.bindFramebuffer(gl.FRAMEBUFFER, nextFBO.fbo);
                gl.bindTexture(gl.TEXTURE_2D, currFBO.tex);
                gl.uniform2f(uDir, 1.0, 0.0);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
                temp = currFBO; currFBO = nextFBO; nextFBO = temp;
            }

            gl.bindFramebuffer(gl.FRAMEBUFFER, null); 
            gl.viewport(0, 0, state.width, state.height);
            gl.useProgram(state.programs.composite);
            bindQuad(state.programs.composite);
            gl.activeTexture(gl.TEXTURE0);
            gl.bindTexture(gl.TEXTURE_2D, state.fboBase.tex);
            gl.uniform1i(gl.getUniformLocation(state.programs.composite, "u_base"), 0);
            gl.activeTexture(gl.TEXTURE1);
            gl.bindTexture(gl.TEXTURE_2D, currFBO.tex);
            gl.uniform1i(gl.getUniformLocation(state.programs.composite, "u_bloom"), 1);
            gl.uniform1f(gl.getUniformLocation(state.programs.composite, "u_bloomStrength"), document.getElementById('bloomStrength').value / 100);
            gl.uniform1f(gl.getUniformLocation(state.programs.composite, "u_grain"), document.getElementById('grain').value / 100);
            gl.uniform1f(gl.getUniformLocation(state.programs.composite, "u_vignette"), document.getElementById('vignette').value / 100);
            gl.uniform1f(gl.getUniformLocation(state.programs.composite, "u_aberration"), document.getElementById('aberration').value / 100);
            gl.uniform1f(gl.getUniformLocation(state.programs.composite, "u_time"), Date.now() / 1000);
            gl.drawArrays(gl.TRIANGLES, 0, 6);
        }

        function bindQuad(prog) {
            const posLoc = gl.getAttribLocation(prog, "a_position");
            const texLoc = gl.getAttribLocation(prog, "a_texCoord");
            gl.enableVertexAttribArray(posLoc);
            gl.enableVertexAttribArray(texLoc);
            gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 16, 0);
            gl.vertexAttribPointer(texLoc, 2, gl.FLOAT, false, 16, 8);
        }

        function bindUniformsPreprocess() {
            const p = state.programs.preprocess;
            const getVal = (id) => parseInt(document.getElementById(id).value);
            gl.uniform1f(gl.getUniformLocation(p, "u_exposure"), getVal('exposure')/100);
            gl.uniform1f(gl.getUniformLocation(p, "u_contrast"), getVal('contrast')/100);
            gl.uniform1f(gl.getUniformLocation(p, "u_saturation"), getVal('saturation')/100);
            gl.uniform1f(gl.getUniformLocation(p, "u_temp"), getVal('temperature')/50);
            gl.uniform1f(gl.getUniformLocation(p, "u_highs"), getVal('highlights')/100);
            gl.uniform1f(gl.getUniformLocation(p, "u_shadows"), getVal('shadows')/100);
            gl.uniform1f(gl.getUniformLocation(p, "u_bloomThresh"), getVal('bloomThreshold')/100);
        }

        const inputs = ['bloomStrength','bloomThreshold','bloomRadius','grain','vignette','aberration','temperature','exposure','contrast','saturation','highlights','shadows'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            const disp = document.getElementById(id + 'Val');
            el.addEventListener('input', (e) => {
                if(disp) {
                    let val = e.target.value;
                    if(id === 'bloomThreshold') val = (val/100).toFixed(2);
                    if(id === 'bloomStrength') val = (val/100).toFixed(1);
                    disp.textContent = val;
                }
                requestAnimationFrame(render);
            });
        });

        const compareBtn = document.getElementById('compareBtn');
        const compareLabel = document.getElementById('compareLabel');
        const startCompare = (e) => { e.preventDefault(); state.isComparing = true; compareLabel.classList.remove('hidden'); render(); };
        const endCompare = (e) => { e.preventDefault(); state.isComparing = false; compareLabel.classList.add('hidden'); render(); };
        compareBtn.addEventListener('mousedown', startCompare);
        compareBtn.addEventListener('mouseup', endCompare);
        compareBtn.addEventListener('mouseleave', endCompare);
        compareBtn.addEventListener('touchstart', startCompare);
        compareBtn.addEventListener('touchend', endCompare);

        const uploadInput = document.getElementById('uploadInput');
        uploadInput.addEventListener('change', (e) => {
            if(e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => loadImage(evt.target.result);
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#8b5cf6'; });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = 'transparent'; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.style.borderColor = 'transparent';
            if(e.dataTransfer.files && e.dataTransfer.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => loadImage(evt.target.result);
                reader.readAsDataURL(e.dataTransfer.files[0]);
            }
        });

        const saveModal = document.getElementById('saveModal');
        const saveImg = document.getElementById('saveImg');
        const closeModalBtn = document.getElementById('closeModalBtn');
        document.getElementById('downloadBtn').addEventListener('click', () => {
            render();
            const dataURL = canvas.toDataURL('image/png', 1.0);
            saveImg.src = dataURL;
            saveModal.classList.add('active');
        });
        closeModalBtn.addEventListener('click', () => saveModal.classList.remove('active'));
        saveModal.addEventListener('click', (e) => { if(e.target === saveModal) saveModal.classList.remove('active'); });

        document.getElementById('resetBtn').addEventListener('click', () => {
            inputs.forEach(id => {
                const el = document.getElementById(id);
                el.value = el.getAttribute('value') || 0;
                el.dispatchEvent(new Event('input'));
            });
        });

        initGL();
    </script>
</body>
</html>
